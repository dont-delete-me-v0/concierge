# Руководство по резервному копированию базы данных

## Обзор

Проект включает полную систему резервного копирования PostgreSQL с автоматическими и ручными бэкапами.

## Возможности

- ✅ **Автоматические бэкапы** по расписанию (cron)
- ✅ **Ручные бэкапы** через команды make
- ✅ **Восстановление** из любого бэкапа
- ✅ **Автоматическая ротация** старых бэкапов (30 дней по умолчанию)
- ✅ **Сжатие** всех бэкапов (gzip)
- ✅ **Логирование** процесса бэкапа

## Конфигурация

### Переменные окружения

Добавьте в ваш `.env` файл:

```bash
# Backup Configuration
BACKUP_SCHEDULE=0 2 * * *      # Расписание (cron формат): каждый день в 2:00
BACKUP_RETENTION_DAYS=30       # Срок хранения бэкапов в днях
```

### Расписание (Cron формат)

```
* * * * *
│ │ │ │ │
│ │ │ │ └─── День недели (0-7, где 0 и 7 = воскресенье)
│ │ │ └───── Месяц (1-12)
│ │ └─────── День месяца (1-31)
│ └───────── Час (0-23)
└─────────── Минута (0-59)
```

Примеры:

- `0 2 * * *` - каждый день в 02:00
- `0 */6 * * *` - каждые 6 часов
- `0 2 * * 0` - каждое воскресенье в 02:00
- `30 1 1 * *` - первый день месяца в 01:30

## Использование

### 1. Запуск сервиса автоматических бэкапов

Автоматический бэкап запускается с docker-compose:

```bash
docker-compose up -d db-backup
```

Проверить статус:

```bash
docker ps | grep backup
```

Посмотреть логи:

```bash
make db-backup-logs
# или
docker logs concierge-postgres-backup -f
```

### 2. Ручное создание бэкапа

#### Вариант А: Через Docker (рекомендуется)

```bash
make backup
```

#### Вариант Б: Прямое подключение к БД

Требуется доступ к PostgreSQL через localhost:

```bash
make backup-manual
```

### 3. Просмотр списка бэкапов

```bash
make list-backups
```

Вывод:

```
Available backups:
-rw-r--r--  1 user  staff   234K Oct 14 10:30 auto_backup_20241014_103000.sql.gz
-rw-r--r--  1 user  staff   235K Oct 13 02:00 auto_backup_20241013_020000.sql.gz
-rw-r--r--  1 user  staff   231K Oct 12 02:00 auto_backup_20241012_020000.sql.gz
```

### 4. Восстановление из бэкапа

⚠️ **ВНИМАНИЕ**: Восстановление удалит все текущие данные в базе!

```bash
make restore FILE=packages/database/backups/auto_backup_20241014_103000.sql.gz
```

Процесс восстановления:

1. Запросит подтверждение (`yes`)
2. Удалит существующую БД
3. Создаст новую БД
4. Восстановит данные из бэкапа

## Структура файлов

```
packages/database/
├── backups/                    # Директория с бэкапами (не в git)
│   ├── auto_backup_*.sql.gz   # Автоматические бэкапы
│   └── manual_*.sql.gz        # Ручные бэкапы
├── backup.sh                   # Скрипт ручного бэкапа
├── restore.sh                  # Скрипт восстановления
├── docker-backup.sh            # Скрипт бэкапа через Docker
├── backup-cron.sh              # Скрипт для автоматических бэкапов
└── BACKUP_GUIDE.md            # Эта документация
```

## Типы бэкапов

### Автоматические бэкапы

- Префикс: `auto_backup_YYYYMMDD_HHMMSS.sql.gz`
- Создаются по расписанию (cron)
- Автоматическая ротация старых бэкапов

### Ручные бэкапы

- Префикс: `manual_YYYYMMDD_HHMMSS.sql.gz`
- Создаются командой `make backup` или `make backup-manual`
- Подходят для бэкапов перед важными изменениями

## Хранение и безопасность

### Текущее решение

- Бэкапы хранятся локально в `packages/database/backups/`
- Директория исключена из Git
- Автоматическая ротация старых файлов

### Рекомендации для продакшена

1. **Удаленное хранилище**

   ```bash
   # Пример: загрузка в S3 после бэкапа
   aws s3 cp backup.sql.gz s3://my-backups/postgres/
   ```

2. **Шифрование бэкапов**

   ```bash
   # Шифрование GPG
   gpg --encrypt --recipient your@email.com backup.sql.gz
   ```

3. **Мониторинг**
   - Настройте оповещения о неудачных бэкапах
   - Регулярно проверяйте логи: `make db-backup-logs`

4. **Тестирование восстановления**
   - Периодически проверяйте, что бэкапы можно восстановить
   - Используйте тестовое окружение

## Устранение проблем

### Бэкап не создается

1. Проверьте статус контейнера:

   ```bash
   docker ps -a | grep backup
   ```

2. Проверьте логи:

   ```bash
   make db-backup-logs
   ```

3. Проверьте права доступа:
   ```bash
   ls -la packages/database/backups/
   ```

### Нет места на диске

```bash
# Очистить старые бэкапы вручную
find packages/database/backups/ -name "*.sql.gz" -mtime +7 -delete
```

### Восстановление не работает

1. Проверьте целостность бэкапа:

   ```bash
   gunzip -t packages/database/backups/backup.sql.gz
   ```

2. Убедитесь, что БД доступна:
   ```bash
   docker exec concierge-postgres pg_isready
   ```

## Команды Make

| Команда                    | Описание                             |
| -------------------------- | ------------------------------------ |
| `make backup`              | Создать бэкап через Docker           |
| `make backup-manual`       | Создать бэкап с прямым подключением  |
| `make restore FILE=<path>` | Восстановить из бэкапа               |
| `make list-backups`        | Показать все бэкапы                  |
| `make db-backup-logs`      | Показать логи автоматических бэкапов |

## Примеры использования

### Перед обновлением схемы БД

```bash
# Создать бэкап перед миграцией
make backup-manual

# Применить миграции
npm run migrate

# Если что-то пошло не так, восстановить
make list-backups
make restore FILE=packages/database/backups/manual_20241014_103000.sql.gz
```

### Копирование БД на другой сервер

```bash
# На сервере А: создать бэкап
make backup

# Скопировать файл на сервер Б
scp packages/database/backups/backup_*.sql.gz server-b:/path/

# На сервере Б: восстановить
make restore FILE=/path/backup_*.sql.gz
```

### Настройка нового окружения

```bash
# Скопировать последний бэкап с продакшена
scp prod:/path/backups/latest.sql.gz ./packages/database/backups/

# Восстановить локально
make restore FILE=packages/database/backups/latest.sql.gz
```

## FAQ

**Q: Как часто создаются автоматические бэкапы?**  
A: По умолчанию каждый день в 02:00. Настраивается через `BACKUP_SCHEDULE` в `.env`.

**Q: Сколько хранятся бэкапы?**  
A: По умолчанию 30 дней. Настраивается через `BACKUP_RETENTION_DAYS` в `.env`.

**Q: Можно ли делать бэкапы чаще?**  
A: Да, измените `BACKUP_SCHEDULE`. Например, `0 */4 * * *` для бэкапа каждые 4 часа.

**Q: Бэкапы занимают много места?**  
A: Бэкапы сжаты gzip, что уменьшает размер в 5-10 раз. Старые бэкапы автоматически удаляются.

**Q: Что делать перед важным обновлением?**  
A: Выполните `make backup-manual` для создания точки восстановления.

**Q: Как проверить, что автоматические бэкапы работают?**  
A: Выполните `make list-backups` и проверьте даты файлов. Также смотрите логи: `make db-backup-logs`.
